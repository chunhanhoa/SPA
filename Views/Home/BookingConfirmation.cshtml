@model int
@{
    ViewData["Title"] = "Xác nhận đặt lịch";
    var bookingId = Model;
    var invoiceId = Context.Request.Query["invoiceId"];
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0"><i class="bi bi-check-circle-fill me-2"></i>Đặt lịch thành công</h3>
                </div>
                <div class="card-body" id="bookingDetails">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2">Đang tải thông tin đặt lịch...</p>
                    </div>
                </div>
                <div class="card-body" id="invoiceDetails">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2">Đang tải thông tin hóa đơn...</p>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <a href="/Home" class="btn btn-outline-secondary">
                            <i class="bi bi-house-door me-1"></i> Quay lại trang chủ
                        </a>
                        <a href="/Home/Services" class="btn btn-primary">
                            <i class="bi bi-list-check me-1"></i> Xem các dịch vụ khác
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadBookingDetails(@bookingId);
            loadInvoiceDetails('@invoiceId');

            function loadBookingDetails(id) {
                $.ajax({
                    url: '/api/Booking/Details/' + id,
                    method: 'GET',
                    success: function(response) {
                        renderBookingDetails(response);
                    },
                    error: function(xhr) {
                        $('#bookingDetails').html(`
                            <div class="alert alert-danger">
                                ${xhr.responseJSON?.message || 'Không thể tải thông tin đặt lịch.'}
                            </div>
                        `);
                    }
                });
            }

            function loadInvoiceDetails(id) {
                if (!id) {
                    $('#invoiceDetails').html('<div class="alert alert-info">Không có hóa đơn.</div>');
                    return;
                }
                $.ajax({
                    url: '/api/Invoice/' + id,
                    method: 'GET',
                    success: function(response) {
                        renderInvoiceDetails(response);
                    },
                    error: function(xhr) {
                        $('#invoiceDetails').html(`
                            <div class="alert alert-danger">
                                ${xhr.responseJSON?.message || 'Không thể tải thông tin hóa đơn.'}
                            </div>
                        `);
                    }
                });
            }

            function renderBookingDetails(data) {
                const appointment = data.appointment || {};
                const services = data.services || [];
                const rooms = data.rooms || [];
                const chairs = data.chairs || [];

                if (!appointment.AppointmentId) {
                    $('#bookingDetails').html('<div class="alert alert-danger">Không tìm thấy thông tin lịch hẹn.</div>');
                    return;
                }

                const startTime = new Date(appointment.StartTime);
                const endTime = new Date(appointment.EndTime);
                const formattedDate = startTime.toLocaleDateString('vi-VN');
                const formattedTime = startTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const formattedEndTime = endTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const formattedAmount = new Intl.NumberFormat('vi-VN').format(appointment.TotalAmount);

                let html = `
                    <div class="booking-confirmed mb-4 text-center">
                        <div class="success-icon mb-3">
                            <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                        </div>
                        <h4>Lịch hẹn #${appointment.AppointmentId}</h4>
                        <p class="text-muted">Cảm ơn bạn đã đặt lịch tại LoanSpa. Chúng tôi sẽ liên hệ xác nhận sớm nhất.</p>
                    </div>
                    
                    <div class="booking-details">
                        <h5 class="mb-3 border-bottom pb-2">Chi tiết lịch hẹn</h5>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Trạng thái:</div>
                            <div class="col-md-8">
                                <span class="badge bg-warning">${appointment.Status}</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Ngày:</div>
                            <div class="col-md-8">${formattedDate}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Giờ bắt đầu:</div>
                            <div class="col-md-8">${formattedTime}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Giờ kết thúc:</div>
                            <div class="col-md-8">${formattedEndTime}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Phòng:</div>
                            <div class="col-md-8">${rooms[0]?.RoomName || 'N/A'}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Ghế:</div>
                            <div class="col-md-8">${chairs.map(c => c.ChairName).join(', ') || 'N/A'}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-4 fw-bold">Tổng tiền:</div>
                            <div class="col-md-8 fw-bold text-primary">${formattedAmount} VNĐ</div>
                        </div>
                        <div class="mt-4">
                            <h5 class="mb-3 border-bottom pb-2">Dịch vụ đã đặt</h5>
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tên dịch vụ</th>
                                        <th class="text-end">Đơn giá</th>
                                        <th class="text-center">Số lượng</th>
                                        <th class="text-end">Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${services.map(s => `
                                        <tr>
                                            <td>${s.ServiceName}</td>
                                            <td class="text-end">${new Intl.NumberFormat('vi-VN').format(s.Price)} VNĐ</td>
                                            <td class="text-center">${s.Quantity}</td>
                                            <td class="text-end">${new Intl.NumberFormat('vi-VN').format(s.Price * s.Quantity)} VNĐ</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                $('#bookingDetails').html(html);
            }

            function renderInvoiceDetails(data) {
                const invoice = data;
                const services = data.services || [];

                if (!invoice.invoiceId) {
                    $('#invoiceDetails').html('<div class="alert alert-danger">Không tìm thấy thông tin hóa đơn.</div>');
                    return;
                }

                const formattedDate = new Date(invoice.createdDate).toLocaleDateString('vi-VN');
                const totalAmount = new Intl.NumberFormat('vi-VN').format(invoice.totalAmount);
                const finalAmount = new Intl.NumberFormat('vi-VN').format(invoice.finalAmount);

                let html = `
                    <div class="mt-4">
                        <h5 class="mb-4 border-bottom pb-2">Chi tiết hóa đơn #${invoice.invoiceId}</h5>
                        <p><strong>Ngày tạo:</strong> ${formattedDate}</p>
                        <p><strong>Khách hàng:</strong> ${invoice.customer?.fullName || 'N/A'} (${invoice.customer?.phone || 'N/A'})</p>
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Tên dịch vụ</th>
                                    <th class="text-end">Đơn giá</th>
                                    <th class="text-center">Số lượng</th>
                                    <th class="text-end">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${services.map(s => `
                                    <tr>
                                        <td>${s.serviceName}</td>
                                        <td class="text-end">${new Intl.NumberFormat('vi-VN').format(s.price)} VNĐ</td>
                                    <td class="text-center">${s.quantity}</td>
                                    <td class="text-end">${new Intl.NumberFormat('vi-VN').format(s.price * s.quantity)} VNĐ</tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <p><strong>Tổng tiền:</strong> ${totalAmount} VNĐ</p>
                        <p><strong>Thành tiền:</strong> ${finalAmount} VNĐ</p>
                    </div>
                `;
                $('#invoiceDetails').html(html);
            }
        });
    </script>
}

@section Styles {
    <style>
        .booking-notes {
            padding-left: 20px;
        }
        .booking-notes li {
            margin-bottom: 8px;
        }
        .success-icon {
            animation: pulse 2s infinite;
        }
        @@keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
}